
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Sheet</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('character')">üßô –ü–µ—Ä—Å–æ–Ω–∞–∂</button>
            <button class="tab-btn" onclick="openTab('generator')">üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
            <button class="tab-btn" onclick="openTab('inventory')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
            <button class="tab-btn" onclick="openTab('dice')">üé≤ –ö—É–±–∏–∫–∏</button>
            <button class="tab-btn" onclick="openTab('notes')">‚úçÔ∏è –ó–∞–º–µ—Ç–∫–∏</button>
            <button class="tab-btn" onclick="openTab('characters')">üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
        <div id="character-tab" class="tab-content active">
            <div class="header">
                <h1 style="font-size: 2.2em; color: #d4af37; margin-bottom: 20px;">‚öîÔ∏è D&D Character Sheet</h1>
                <div class="character-info">
                    <div class="input-group">
                        <label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                        <input type="text" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                    </div>
                    <div class="input-group">
                        <label for="characterSurname">–§–∞–º–∏–ª–∏—è:</label>
                        <input type="text" id="characterSurname" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                    </div>
                    <div class="input-group">
                        <label for="characterTitle">–¢–∏—Ç—É–ª:</label>
                        <input type="text" id="characterTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏—Ç—É–ª">
                    </div>
                </div>

                <div class="character-info">
                    <div class="input-group">
                        <label for="characterRace">–†–∞—Å–∞:</label>
                        <select id="characterRace" onchange="onRaceChange()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É</option>
                            <option value="atski">üî• –ê—Ü–∫–∏ (–ü–µ—Ä—Å—ã)</option>
                            <option value="knofi">üó£Ô∏è –ö–Ω–æ—Ñ—ã (–†–∏–º–ª—è–Ω–µ)</option>
                            <option value="vorki">‚ùÑÔ∏è –í–æ—Ä–∫–∏ (–í–∏–∫–∏–Ω–≥–∏)</option>
                            <option value="minci">üéØ –ú–∏–Ω—Ü—ã (–ê–∑–∏–∞—Ç—ã)</option>
                            <option value="kaei">‚öíÔ∏è –ö–∞—ç–π—Ü—ã (–ù–µ–≥—Ä—ã)</option>
                            <option value="forest_elf">üåø –õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                            <option value="high_elf">‚ú® –í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã</option>
                            <option value="dark_elf">üåë –¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                            <option value="dwarf">‚õ∞Ô∏è –î–≤–∞—Ä—Ñ—ã</option>
                            <option value="gnome">üîÆ –ì–Ω–æ–º—ã</option>
                            <option value="orc">üíÄ –û—Ä–∫–∏</option>
                            <option value="goblin">üëπ –ì–æ–±–ª–∏–Ω—ã</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="characterHeritage">–ù–∞—Å–ª–µ–¥–∏–µ:</label>
                        <input type="text" id="characterHeritage" placeholder="–û—Å–æ–±–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ">
                    </div>
                </div>

                <div class="character-info">
                    <div class="input-group">
                        <label for="characterHeight">–†–æ—Å—Ç (—Å–º):</label>
                        <div class="input-row">
                            <input type="number" id="characterHeight" readonly>
                            <button class="btn" id="generateHeightBtn" onclick="generateHeightForSelectedRace()" style="background: #8b4513; color: white;">üé≤ –ê–≤—Ç–æ</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="characterWeight">–í–µ—Å (–∫–≥):</label>
                        <input type="number" id="characterWeight" placeholder="–í–µ—Å">
                    </div>
                    <div class="input-group">
                        <label for="characterAge">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç):</label>
                        <input type="number" id="characterAge" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
                    </div>
                </div>
            </div>

            <div class="level-system">
                <div class="level-display">
                    <div class="level-info">
                        –£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">0</span>
                        <button class="btn btn-roll" onclick="editLevel()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-roll" onclick="showLevelsTable()">üìä –¢–∞–±–ª–∏—Ü–∞</button>
                    </div>
                    <div class="exp-display">
                        <input type="number" id="currentExp" class="exp-input" value="0" min="0">
                        <span style="color: #d4af37; font-weight: bold;">/ <span id="requiredExp">1000</span> XP</span>
                        <button class="btn btn-plus" onclick="addExperience()">‚ûï –û–ø—ã—Ç</button>
                        <button class="btn btn-roll" id="convertBtn" onclick="convertExpToPoints()" style="display: none;">üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-row">
                    <div class="stat-label">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ:</div>
                    <input type="number" class="stat-input" id="health" value="100">
                    <button class="btn btn-minus" onclick="changeStat('health', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('health', 5)">+5</button>
                </div>
                <div class="stat-row">
                    <div class="stat-label">üîÆ –ú–∞–Ω–∞:</div>
                    <input type="number" class="stat-input" id="mana" value="100">
                    <button class="btn btn-minus" onclick="changeStat('mana', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('mana', 5)">+5</button>
                </div>
                <div class="stat-row">
                    <div class="stat-label">‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å:</div>
                    <input type="number" class="stat-input" id="stamina" value="100">
                    <button class="btn btn-minus" onclick="changeStat('stamina', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('stamina', 5)">+5</button>
                </div>
            </div>

            <div class="points-panel">
                <div class="points-display">
                    <span style="font-size: 1.3em; font-weight: bold; color: #d4af37;">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤:</span>
                    <input type="number" id="freePoints" class="stat-input" value="0">
                    <button class="btn btn-roll" onclick="editFreePoints()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div style="text-align: center; margin-top: 20px; padding: 10px; background: #3d2418; border-radius: 6px;">
    <button class="btn btn-roll" onclick="debugSkills()">üêõ –î–µ–±–∞–≥ –Ω–∞–≤—ã–∫–æ–≤</button>
    <button class="btn btn-roll" onclick="repairSkills()">üîß –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–≤—ã–∫–∏</button>
</div>
            </div>

            <div id="skillsContainer"></div>

            <div class="export-import">
                <button class="btn btn-plus" onclick="exportCharacter()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                <button class="btn btn-roll" onclick="importCharacter()">üì• –ò–º–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
            </div>
        </div>

        <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
        <div id="generator-tab" class="tab-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px;">üé≤ –ú–ê–°–¢–ï–†–°–ö–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò</h2>
            
            <div class="skills-section">
                <div class="section-title">üë§ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <select id="genRace" style="padding: 12px; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É</option>
                        <option value="atski">–ê—Ü–∫–∏</option>
                        <option value="knofi">–ö–Ω–æ—Ñ—ã</option>
                        <option value="vorki">–í–æ—Ä–∫–∏</option>
                        <option value="minci">–ú–∏–Ω—Ü—ã</option>
                        <option value="kaei">–ö–∞—ç–π—Ü—ã</option>
                        <option value="forest_elf">–õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                        <option value="high_elf">–í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã</option>
                        <option value="dark_elf">–¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                        <option value="dwarf">–î–≤–∞—Ä—Ñ—ã</option>
                        <option value="gnome">–ì–Ω–æ–º—ã</option>
                        <option value="orc">–û—Ä–∫–∏</option>
                        <option value="goblin">–ì–æ–±–ª–∏–Ω—ã</option>
                    </select>
                    <select id="genGender" style="padding: 12px; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                        <option value="random">üé≤ –°–ª—É—á–∞–π–Ω—ã–π –ø–æ–ª</option>
                        <option value="male">üë® –ú—É–∂—Å–∫–æ–π</option>
                        <option value="female">üë© –ñ–µ–Ω—Å–∫–∏–π</option>
                    </select>
                </div>
                <button class="btn btn-roll" onclick="generateFullCharacter()" style="width: 100%;">üé≠ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                <div id="characterResult" style="margin-top: 15px; padding: 15px; background: #3d2418; border-radius: 6px; display: none;"></div>
            </div>

            <div class="skills-section">
                <div class="section-title">üèõÔ∏è –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞–∑–≤–∞–Ω–∏–π</div>
                <select id="nameType" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                    <option value="tavern">üç∫ –¢–∞–≤–µ—Ä–Ω–∞</option>
                    <option value="inn">üèöÔ∏è –¢—Ä–∞–∫—Ç–∏—Ä</option>
                    <option value="shop">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</option>
                    <option value="blacksmith">‚öíÔ∏è –ö—É–∑–Ω–∏—Ü–∞</option>
                    <option value="temple">‚õ™ –•—Ä–∞–º</option>
                    <option value="city">üè∞ –ì–æ—Ä–æ–¥</option>
                    <option value="kingdom">üëë –ö–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ</option>
                    <option value="ship">‚õµ –ö–æ—Ä–∞–±–ª—å</option>
                    <option value="gang">üíÄ –ë–∞–Ω–¥–∞</option>
                </select>
                <input type="text" id="nameTheme" placeholder="–¢–µ–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –º–æ—Ä–µ, –ª–µ—Å, –æ–≥–æ–Ω—å)" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-roll" onclick="generateName()" style="width: 100%;">üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</button>
                <div id="nameResult" style="margin-top: 15px; padding: 15px; background: #3d2418; border-radius: 6px; display: none;"></div>
            </div>

            <div class="skills-section">
                <div class="section-title">üé≠ –û—Ç–ª–∏—á–∏—Ç–µ–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã</div>
                <select id="traitType" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                    <option value="appearance">üë® –í–Ω–µ—à–Ω–æ—Å—Ç—å</option>
                    <option value="personality">üòä –•–∞—Ä–∞–∫—Ç–µ—Ä</option>
                    <option value="habit">üîÑ –ü—Ä–∏–≤—ã—á–∫–∞</option>
                    <option value="speech">üí¨ –†–µ—á—å</option>
                    <option value="clothing">üëï –û–¥–µ–∂–¥–∞</option>
                </select>
                <input type="text" id="traitTheme" placeholder="–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –º–æ—Ä–µ, –º–∞–≥–∏—è, –±–æ–µ—Ü)" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-roll" onclick="generateTrait()" style="width: 100%;">üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä—Ç—É</button>
                <div id="traitResult" style="margin-top: 15px; padding: 15px; background: #3d2418; border-radius: 6px; display: none;"></div>
            </div>

            <div class="skills-section">
                <div class="section-title">üéØ –ü—Ä–æ–∑–≤–∏—â–∞ –∏ –∫–ª–∏—á–∫–∏</div>
                <select id="nicknameType" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                    <option value="heroic">ü¶∏ –ì–µ—Ä–æ–∏—á–µ—Å–∫–æ–µ</option>
                    <option value="fearful">üò® –ü—É–≥–∞—é—â–µ–µ</option>
                    <option value="funny">üòÑ –°–º–µ—à–Ω–æ–µ</option>
                    <option value="descriptive">üìù –û–ø–∏—Å–∞—Ç–µ–ª—å–Ω–æ–µ</option>
                    <option value="animal">üê∫ –ó–≤–µ—Ä–∏–Ω–æ–µ</option>
                </select>
                <button class="btn btn-roll" onclick="generateNickname()" style="width: 100%;">üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∑–≤–∏—â–µ</button>
                <div id="nicknameResult" style="margin-top: 15px; padding: 15px; background: #3d2418; border-radius: 6px; display: none;"></div>
            </div>
        </div>

        <div id="inventory-tab" class="tab-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px;">üéí –ò–ù–í–ï–ù–¢–ê–†–¨</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-plus" onclick="showAddItemPopup()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                <button class="btn btn-roll" onclick="showAddCategoryPopup()">üìÅ –°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–¥–µ–ª</button>
            </div>

            <div class="custom-categories" id="customCategoriesSection" style="display: none;">
                <h3 style="color: #d4af37; margin-bottom: 15px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã</h3>
                <div class="category-management">
                    <input type="text" id="newCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞" style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                    <button class="btn btn-plus" onclick="addCustomCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="customCategoriesList"></div>
            </div>
            
            <input type="text" class="search-box" id="inventorySearch" placeholder="üîç –ü–æ–∏—Å–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ...">
            <div id="inventoryContainer"></div>
        </div>

        <div id="dice-tab" class="tab-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px;">üé≤ –°–ò–°–¢–ï–ú–ê –ë–†–û–°–ö–û–í</h2>
            
            <div class="dice-controls">
                <span style="color: #d4af37;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–±–∏–∫–æ–≤:</span>
                <input type="number" id="diceCount" class="dice-count" value="1" min="1" max="10">
            </div>

            <div class="dice-container">
                <button class="btn btn-dice" onclick="rollDice('coin')">ü™ô –ú–æ–Ω–µ—Ç–∫–∞</button>
                <button class="btn btn-dice" onclick="rollDice(4)">D4</button>
                <button class="btn btn-dice" onclick="rollDice(6)">D6</button>
                <button class="btn btn-dice" onclick="rollDice(8)">D8</button>
                <button class="btn btn-dice" onclick="rollDice(10)">D10</button>
                <button class="btn btn-dice" onclick="rollDice(12)">D12</button>
                <button class="btn btn-dice" onclick="rollDice(20)">D20</button>
                <button class="btn btn-dice" onclick="rollDice(100)">D100</button>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <button class="btn btn-dice" onclick="rollCustomDice()">‚ö´ D0</button>
                    <input type="number" id="customDiceSides" class="custom-dice-input" value="6" min="2" max="1000" placeholder="–ì—Ä–∞–Ω–∏">
                </div>
            </div>

            <div id="diceResults" style="margin-top: 30px; text-align: center;"></div>
            <div id="diceHistory" style="margin-top: 20px;"></div>
        </div>

        <div id="notes-tab" class="tab-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px;">‚úçÔ∏è –°–ò–°–¢–ï–ú–ê –ó–ê–ú–ï–¢–û–ö</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-plus" onclick="showAddNotePopup()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
            </div>
            
            <input type="text" class="search-box" id="notesSearch" placeholder="üîç –ü–æ–∏—Å–∫ –≤ –∑–∞–º–µ—Ç–∫–∞—Ö...">
            
            <div class="notes-container" id="notesContainer"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏ -->
        <div id="characters-tab" class="tab-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px;">üë• –ú–ï–ù–ï–î–ñ–ï–† –ü–ï–†–°–û–ù–ê–ñ–ï–ô</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-plus" onclick="showCreateCharacterPopup()">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                <button class="btn btn-roll" onclick="showImportCharacterPopup()">üì• –ò–º–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
            </div>

            <div class="skills-section">
                <div class="section-title">üìÇ –í–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
                <div id="charactersList" style="min-height: 200px;">
                    <p style="color: #8b7d6b; text-align: center;">–ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                </div>
            </div>

            <div class="skills-section">
                <div class="section-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn btn-roll" onclick="exportAllCharacters()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö</button>
                    <button class="btn btn-minus" onclick="showClearAllPopup()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
                </div>
            </div>
        </div>
    </div>
   <script type="module">
import { renderSkills } from './js/modules/skills-system.js';
// ========== –í–°–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ò –°–¢–†–£–ö–¢–£–†–´ ==========
// –î–∏–∞–ø–∞–∑–æ–Ω—ã —Ä–æ—Å—Ç–∞ –¥–ª—è —Ä–∞—Å
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤
// –ë–∞–∑–æ–≤—ã–µ —à–∫–æ–ª—ã –º–∞–≥–∏–∏
// –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è –º–∞–≥–∏–∏ –≤–æ–¥—ã
// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –∏–º–µ–Ω –¥–ª—è —Ä–∞—Å
// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –Ω–∞–∑–≤–∞–Ω–∏–π
// –û—Ç–ª–∏—á–∏—Ç–µ–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã
// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let characters = {};
let currentCharacterId = null;
let availableMagicSchools = {};
let notes = [];
let inventory = {
    weapons: [],
    armor: [],
    potions: [],
    scrolls: [],
    resources: [],
    valuables: [],
    tools: [],
    other: []
};
let diceHistory = [];
let lockedSkills = {};
let customCategories = [];
let skillRollHistory = {};
        // ========== –î–û–ë–ê–í–ò–ú –ù–ï–î–û–°–¢–ê–Æ–©–ò–ï –§–£–ù–ö–¶–ò–ò ==========

function updateUI() {
    const freePoints = getFreePoints();
    
    document.querySelectorAll('.skill-row').forEach(row => {
        const skillName = row.querySelector('.skill-name span:nth-child(2)').textContent;
        const skillValue = getSkillValue(skillName);
        const isLocked = isSkillLocked(skillName);
        const minusBtn = row.querySelector('.btn-minus');
        const plusBtn = row.querySelector('.btn-plus');
        const rollBtn = row.querySelector('.btn-roll');
        
        row.querySelector('.skill-value').textContent = skillValue;
        
        if (isLocked) {
            minusBtn.disabled = true;
            plusBtn.disabled = true;
            rollBtn.disabled = true;
            row.classList.add('skill-locked');
        } else {
            minusBtn.disabled = skillValue <= 5;
            plusBtn.disabled = freePoints <= 0;
            rollBtn.disabled = false;
            row.classList.remove('skill-locked');
        }
    });
    
    updateMagicSkillsDisplay();
    document.getElementById('freePoints').value = freePoints;
}

function updateMagicSkillsDisplay() {
    const magicSkills = skillsStructure["üîÆ –ú–ê–ì–ò–Ø"];
    magicSkills.forEach(skill => {
        const skillElement = document.getElementById(`skill-${skill}`);
        if (skillElement) {
            const skillRow = skillElement.closest('.skill-row');
            const isAvailable = availableMagicSchools[skill] || getSkillValue(skill) > 5;
            if (skillRow) {
                skillRow.classList.toggle('skill-disabled', !isAvailable);
                
                if (!isAvailable && getSkillValue(skill) <= 5) {
                    const minusBtn = skillRow.querySelector('.btn-minus');
                    const plusBtn = skillRow.querySelector('.btn-plus');
                    const rollBtn = skillRow.querySelector('.btn-roll');
                    
                    minusBtn.disabled = true;
                    plusBtn.disabled = true;
                    rollBtn.disabled = true;
                }
            }
        }
    });
}

function forceRenderSkills() {
    const container = document.getElementById('skillsContainer');
    if (!container) return;
    renderSkills();
}

function debugSkills() {
    console.log('üîç –î–ï–ë–ê–ì –ù–ê–í–´–ö–û–í:');
    Object.values(skillsStructure).forEach((skillGroup, groupIndex) => {
        console.log(`–ì—Ä—É–ø–ø–∞ ${groupIndex + 1}:`);
        skillGroup.forEach(skill => {
            const value = getSkillValue(skill);
            console.log(`  ${skill}: ${value}`);
        });
    });
}

function repairSkills() {
    Object.values(skillsStructure).forEach(skillGroup => {
        skillGroup.forEach(skill => {
            const currentValue = getSkillValue(skill);
            if (currentValue < 5 || isNaN(currentValue)) {
                setSkillValue(skill, 5);
            }
        });
    });
    renderSkills();
    updateUI();
}
</script>
<script>
// ========== –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò –ò –°–û–•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–• ==========

function loadSkillRollHistory() {
    const saved = localStorage.getItem('skillRollHistory');
    if (saved) {
        skillRollHistory = JSON.parse(saved);
    }
}

function saveSkillRollHistory() {
    localStorage.setItem('skillRollHistory', JSON.stringify(skillRollHistory));
}

function loadLockedSkills() {
    const saved = localStorage.getItem('lockedSkills');
    if (saved) {
        lockedSkills = JSON.parse(saved);
    }
}

function saveLockedSkills() {
    localStorage.setItem('lockedSkills', JSON.stringify(lockedSkills));
}

function loadCustomCategories() {
    const saved = localStorage.getItem('customCategories');
    if (saved) {
        customCategories = JSON.parse(saved);
        updateCategoryManagement();
    }
}

function saveCustomCategories() {
    localStorage.setItem('customCategories', JSON.stringify(customCategories));
}

function loadSpells() {
    const saved = localStorage.getItem('characterSpells');
    if (saved) {
        const data = JSON.parse(saved);
        Object.keys(spellsBySchool).forEach(school => {
            if (data[school]) {
                spellsBySchool[school] = data[school];
            }
        });
    }
}

function saveSpells() {
    localStorage.setItem('characterSpells', JSON.stringify(spellsBySchool));
}

function loadNotes() {
    const saved = localStorage.getItem('characterNotes');
    if (saved) {
        notes = JSON.parse(saved);
    }
}

function saveNotes() {
    localStorage.setItem('characterNotes', JSON.stringify(notes));
}

function loadInventory() {
    const saved = localStorage.getItem('inventoryData');
    if (saved) {
        inventory = JSON.parse(saved);
    }
}

function saveInventory() {
    localStorage.setItem('inventoryData', JSON.stringify(inventory));
}

// ========== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –í–ö–õ–ê–î–ö–ê–ú–ò ==========
// ========== –°–ò–°–¢–ï–ú–ê –†–ê–° ==========
function setRace(raceId) {
    const race = races[raceId];
    if (!race) return;
    
    availableMagicSchools = {};
    document.getElementById('characterRace').value = raceId;
    
    const randomHeight = generateRandomHeight(raceId);
    document.getElementById('characterHeight').value = randomHeight;
    
    const lifespan = parseInt(race.lifespan);
    document.getElementById('characterAge').value = Math.max(15, Math.floor(lifespan * 0.1));
    
    document.getElementById('generateHeightBtn').disabled = true;
    
    determineAvailableMagicSchools(raceId);
    applyRaceBonuses(raceId);
    
    saveCharacterData();
    document.querySelector('.popup').remove();
    alert(`‚úÖ –†–∞—Å–∞ "${race.name}" –≤—ã–±—Ä–∞–Ω–∞!\nüìè –†–æ—Å—Ç: ${randomHeight} —Å–º`);
}

function determineAvailableMagicSchools(raceId) {
    availableMagicSchools = {};
    
    switch(raceId) {
        case 'forest_elf':
            availableMagicSchools["–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã"] = true;
            break;
        case 'dark_elf':
            availableMagicSchools["–ú–∞–≥–∏—è —Ç—å–º—ã"] = true;
            break;
        case 'high_elf':
            const shuffled = [...baseMagicSchools].sort(() => 0.5 - Math.random());
            availableMagicSchools[shuffled[0]] = true;
            availableMagicSchools[shuffled[1]] = true;
            break;
        case 'goblin':
            break;
        default:
            const randomSchool = baseMagicSchools[Math.floor(Math.random() * baseMagicSchools.length)];
            availableMagicSchools[randomSchool] = true;
    }
    
    const race = races[raceId];
    if (race && race.limitations) {
        Object.keys(race.limitations).forEach(school => {
            if (race.limitations[school] === 0) {
                availableMagicSchools[school] = false;
            }
        });
    }
    
    updateMagicSkillsDisplay();
}

function applyRaceBonuses(raceId) {
    const race = races[raceId];
    if (!race || !race.bonuses) return;
    
    Object.entries(race.bonuses).forEach(([skill, bonus]) => {
        const currentValue = getSkillValue(skill);
        setSkillValue(skill, currentValue + bonus);
    });
    
    updateUI();
}
    document.getElementById('characterHeight').value = randomHeight;
    document.getElementById('generateHeightBtn').disabled = true;
    saveCharacterData();
    alert(`üìè –ù–æ–≤—ã–π —Ä–æ—Å—Ç: ${randomHeight} —Å–º`);

// ========== –°–ò–°–¢–ï–ú–ê –ù–ê–í–´–ö–û–í –ò –ú–ê–ì–ò–ò ==========

function updateMagicSkillsDisplay() {
    const magicSkills = skillsStructure["üîÆ –ú–ê–ì–ò–Ø"];
    magicSkills.forEach(skill => {
        const skillElement = document.getElementById(`skill-${skill}`);
        if (skillElement) {
            const skillRow = skillElement.closest('.skill-row');
            const isAvailable = availableMagicSchools[skill] || getSkillValue(skill) > 5;
            if (skillRow) {
                skillRow.classList.toggle('skill-disabled', !isAvailable);
            }
        }
    });
}



function isSkillLocked(skillName) {
    return lockedSkills[skillName] || false;
}

function toggleSkillLock(skillName) {
    const currentlyLocked = isSkillLocked(skillName);
    
    if (currentlyLocked) {
        const unlock = confirm(`üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫ "${skillName}"?\n\n–ù–∞–≤—ã–∫ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–∫–∞—á–∫–∏.`);
        if (unlock) {
            lockedSkills[skillName] = false;
            saveLockedSkills();
            renderSkills();
            updateUI();
            alert(`‚úÖ –ù–∞–≤—ã–∫ "${skillName}" —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
        }
    } else {
        const lock = confirm(`üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫ "${skillName}"?\n\n–ù–∞–≤—ã–∫ —Å—Ç–∞–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–∫–∞—á–∫–∏.`);
        if (lock) {
            lockedSkills[skillName] = true;
            saveLockedSkills();
            renderSkills();
            updateUI();
            alert(`‚úÖ –ù–∞–≤—ã–∫ "${skillName}" –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
        }
    }
}

function getSkillHistory(skillName) {
    return skillRollHistory[skillName] || [];
}

function rollSkill(skillName) {
    if (isSkillLocked(skillName)) {
        alert('‚ùå –≠—Ç–æ—Ç –Ω–∞–≤—ã–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!');
        return;
    }
    
    const skillValue = getSkillValue(skillName);
    const roll1 = Math.floor(Math.random() * 6) + 1;
    const roll2 = Math.floor(Math.random() * 6) + 1;
    const roll3 = Math.floor(Math.random() * 6) + 1;
    const totalRoll = roll1 + roll2 + roll3;

    let resultText, resultClass;
    if (totalRoll === 3 || totalRoll === 4) {
        resultText = "üí´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•!";
        resultClass = "success";
    } else if (totalRoll === 17 || totalRoll === 18) {
        resultText = "üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ!";
        resultClass = "failure";
    } else if (totalRoll <= skillValue) {
        resultText = "‚úÖ –£–°–ü–ï–•!";
        resultClass = "success";
    } else {
        resultText = "‚ùå –ù–ï–£–î–ê–ß–ê!";
        resultClass = "failure";
    }

    showRollResult(skillName, skillValue, [roll1, roll2, roll3], totalRoll, resultText, resultClass);
}

function showRollResult(skillName, skillValue, dice, total, resultText, resultClass) {
    addToSkillHistory(skillName, {
        skillValue: skillValue,
        dice: dice,
        total: total,
        result: resultText,
        success: resultClass === "success"
    });
    
    const history = getSkillHistory(skillName);
    let historyHTML = '';
    
    if (history.length > 0) {
        historyHTML = `
            <div style="margin-top: 20px; border-top: 2px solid #5a3928; padding-top: 15px;">
                <h4 style="color: #d4af37; margin-bottom: 10px;">üìä –ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤ (${history.length}/10):</h4>
                <div style="max-height: 150px; overflow-y: auto;">
        `;
        
        history.forEach((roll, index) => {
            const successIcon = roll.success ? '‚úÖ' : '‚ùå';
            historyHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #3d2418;">
                    <span style="font-size: 0.9em;">${roll.timestamp}</span>
                    <span style="font-size: 0.9em;">${roll.dice.join('+')}=${roll.total}</span>
                    <span>${successIcon}</span>
                </div>
            `;
        });
        
        historyHTML += `</div></div>`;
    }
    
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
        <div class="popup-content">
            <h2 style="color: #d4af37;">–ë—Ä–æ—Å–æ–∫ –Ω–∞ "${skillName}" (${skillValue})</h2>
            <div class="dice-rolls">
                <div class="dice">${dice[0]}</div>
                <div class="dice">${dice[1]}</div>
                <div class="dice">${dice[2]}</div>
            </div>
            <div style="font-size: 1.5em; margin: 20px 0; color: #e0d0c0;">${dice.join(' + ')} = ${total}</div>
            <div class="${resultClass}">${resultText}</div>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn btn-roll" onclick="rollSkill('${skillName}'); this.closest('.popup').remove();">üé≤ –ö–∏–Ω—É—Ç—å –µ—â–µ</button>
                <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            
            ${historyHTML}
        </div>
    `;
    document.body.appendChild(popup);
}

// ========== –°–ò–°–¢–ï–ú–ê –ó–ê–ö–õ–ò–ù–ê–ù–ò–ô ==========
function showSpells(schoolName) {
    if (!availableMagicSchools[schoolName] && getSkillValue(schoolName) <= 5) {
        alert('‚ùå –≠—Ç–∞ —à–∫–æ–ª–∞ –º–∞–≥–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤–∞—à–µ–π —Ä–∞—Å—ã!');
        return;
    }
    
    const spells = spellsBySchool[schoolName] || [];
    const popup = document.createElement('div');
    popup.className = 'popup';
    
    let spellsHTML = '';
    spells.forEach((spell, index) => {
        spellsHTML += `
            <div class="spell-item">
                <div class="spell-header">
                    <span class="spell-name">${spell.name}</span>
                    <span class="spell-order">–ü–æ—Ä—è–¥–æ–∫ ${spell.order}</span>
                </div>
                <div class="spell-details">
                    <p><strong>–≠—Ñ—Ñ–µ–∫—Ç:</strong> ${spell.effect}</p>
                    <p><strong>–¢–∏–ø:</strong> ${spell.type}</p>
                    <p><strong>–£—Å–ª–æ–≤–∏—è:</strong> ${spell.conditions}</p>
                    <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${spell.duration}</p>
                    <p><strong>–ó–∞—Ç—Ä–∞—Ç—ã:</strong> ${spell.cost}</p>
                </div>
                <div class="spell-learned">
                    <input type="checkbox" id="spell-${schoolName}-${index}" 
                           ${spell.learned ? 'checked' : ''} 
                           onchange="toggleSpellLearned('${schoolName}', ${index})">
                    <label for="spell-${schoolName}-${index}" style="color: #e0d0c0;">–ò–∑—É—á–µ–Ω–æ</label>
                </div>
            </div>
        `;
    });
    
    popup.innerHTML = `
        <div class="popup-content spells-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 20px;">üîÆ ${schoolName}</h2>
            <div style="max-height: 60vh; overflow-y: auto;">
                ${spellsHTML || '<p style="text-align: center; color: #8b7d6b;">–ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>'}
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}

function toggleSpellLearned(schoolName, spellIndex) {
    if (spellsBySchool[schoolName] && spellsBySchool[schoolName][spellIndex]) {
        spellsBySchool[schoolName][spellIndex].learned = 
            !spellsBySchool[schoolName][spellIndex].learned;
        saveSpells();
    }
}
</script>
<script>
// ========== –°–ò–°–¢–ï–ú–ê –£–†–û–í–ù–ï–ô –ò –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö ==========

function addExperience() {
    const expToAdd = prompt('–°–∫–æ–ª—å–∫–æ –æ–ø—ã—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å?');
    if (expToAdd && !isNaN(expToAdd)) {
        let currentExp = getCurrentExp();
        currentExp += parseInt(expToAdd);
        setCurrentExp(currentExp);
        checkLevelUp();
        updateLevelDisplay();
        saveCharacterData();
    }
}

function checkLevelUp() {
    let currentLevel = getCurrentLevel();
    let currentExp = getCurrentExp();
    
    if (currentLevel >= 9) return;
    
    while (currentLevel < 9 && currentExp >= levelTable[currentLevel].expRequired) {
        currentLevel++;
        
        const health = getHealth() + levelTable[currentLevel].hp;
        const mana = getMana() + levelTable[currentLevel].mana;
        const stamina = getStamina() + levelTable[currentLevel].stamina;
        const freePoints = getFreePoints() + levelTable[currentLevel].points;
        
        setHealth(health);
        setMana(mana);
        setStamina(stamina);
        setFreePoints(freePoints);
        
        currentExp = currentExp - levelTable[currentLevel-1].expRequired;
        setCurrentExp(currentExp);
        setCurrentLevel(currentLevel);
        
        alert(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω –¥–æ ${currentLevel}!`);
    }
}

function editLevel() {
    const newLevel = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (0-9):', getCurrentLevel());
    if (newLevel && !isNaN(newLevel) && newLevel >= 0 && newLevel <= 9) {
        setCurrentLevel(parseInt(newLevel));
        updateStatsForLevel();
        updateLevelDisplay();
        saveCharacterData();
    }
}

function updateStatsForLevel() {
    const currentLevel = getCurrentLevel();
    let totalHP = 100, totalMana = 100, totalStamina = 100;
    
    for (let i = 0; i <= currentLevel; i++) {
        totalHP += levelTable[i].hp;
        totalMana += levelTable[i].mana;
        totalStamina += levelTable[i].stamina;
    }
    
    setHealth(totalHP);
    setMana(totalMana);
    setStamina(totalStamina);
}

function convertExpToPoints() {
    const currentExp = getCurrentExp();
    const availablePoints = Math.floor(currentExp / 1000);
    
    if (availablePoints > 0) {
        const expToConvert = availablePoints * 1000;
        setCurrentExp(currentExp - expToConvert);
        setFreePoints(getFreePoints() + availablePoints);
        
        alert(`üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${availablePoints} –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤!`);
        updateLevelDisplay();
        updateUI();
        saveCharacterData();
    }
}

function updateLevelDisplay() {
    const currentLevel = getCurrentLevel();
    const currentExp = getCurrentExp();
    const convertBtn = document.getElementById('convertBtn');
    
    document.getElementById('currentLevel').textContent = currentLevel;
    document.getElementById('currentExp').value = currentExp;
    
    if (currentLevel < 9) {
        document.getElementById('requiredExp').textContent = levelTable[currentLevel].expRequired;
        convertBtn.style.display = 'none';
    } else {
        document.getElementById('requiredExp').textContent = 'MAX';
        convertBtn.style.display = 'block';
    }
}

function showLevelsTable() {
    const currentLevel = getCurrentLevel();
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
        <div class="popup-content">
            <h2 style="color: #d4af37; margin-bottom: 20px;">üìä –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π</h2>
            <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                <tr><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–£—Ä.</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–û–ø—ã—Ç</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–•–ü</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–ú–∞–Ω–∞</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–°—Ç–∞–º–∏–Ω–∞</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–û—á–∫–∏</th></tr>
                ${Object.entries(levelTable).map(([level, data]) => `
                    <tr style="${level == currentLevel ? 'background: #8b4513; font-weight: bold;' : ''}">
                        <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">${level}</td>
                        <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">${data.expRequired || 'MAX'}</td>
                        <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.hp}</td>
                        <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.mana}</td>
                        <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.stamina}</td>
                        <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.points}</td>
                    </tr>
                `).join('')}
            </table>
            <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    `;
    document.body.appendChild(popup);
}

function changeStat(stat, value) {
    const input = document.getElementById(stat);
    let currentValue = parseInt(input.value) || 0;
    let newValue = currentValue + value;
    if (newValue < 0) newValue = 0;
    input.value = newValue;
    saveCharacterData();
}

function editFreePoints() {
    const newPoints = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤:', getFreePoints());
    if (newPoints && !isNaN(newPoints)) {
        setFreePoints(parseInt(newPoints));
        updateUI();
        saveCharacterData();
    }
}

function updateUI() {
    const freePoints = getFreePoints();
    
    document.querySelectorAll('.skill-row').forEach(row => {
        const skillName = row.querySelector('.skill-name span:nth-child(2)').textContent;
        const skillValue = getSkillValue(skillName);
        const isLocked = isSkillLocked(skillName);
        const minusBtn = row.querySelector('.btn-minus');
        const plusBtn = row.querySelector('.btn-plus');
        const rollBtn = row.querySelector('.btn-roll');
        
        row.querySelector('.skill-value').textContent = skillValue;
        
        if (isLocked) {
            minusBtn.disabled = true;
            plusBtn.disabled = false;
            rollBtn.disabled = true;
            row.classList.add('skill-locked');
        } else {
            minusBtn.disabled = skillValue <= 5;
            plusBtn.disabled = freePoints <= 0;
            rollBtn.disabled = false;
            row.classList.remove('skill-locked');
        }
    });
    
    updateMagicSkillsDisplay();
}

// ========== –°–ò–°–¢–ï–ú–ê –ò–ù–í–ï–ù–¢–ê–†–Ø ==========

function showAddItemPopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    
    let categoryOptions = '';
    
    const standardCategories = [
        { id: 'weapons', name: '‚öîÔ∏è –û—Ä—É–∂–∏–µ' },
        { id: 'armor', name: 'üõ°Ô∏è –ë—Ä–æ–Ω—è' },
        { id: 'potions', name: 'üß™ –ó–µ–ª—å—è' },
        { id: 'scrolls', name: 'üìú –°–≤–∏—Ç–∫–∏' },
        { id: 'resources', name: 'üíé –†–µ—Å—É—Ä—Å—ã' },
        { id: 'valuables', name: 'üí∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏' },
        { id: 'tools', name: 'üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã' },
        { id: 'other', name: 'üéí –ü—Ä–æ—á–µ–µ' }
    ];
    
    standardCategories.forEach(cat => {
        categoryOptions += `<option value="${cat.id}">${cat.name}</option>`;
    });
    
    customCategories.forEach(catId => {
        const catName = getCategoryName(catId);
        categoryOptions += `<option value="${catId}">${catName}</option>`;
    });
    
    popup.innerHTML = `
        <div class="popup-content">
            <h2 style="color: #d4af37;">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h2>
            <input type="text" id="itemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
            
            <select id="itemCategory" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
                ${categoryOptions}
            </select>
            
            <input type="number" id="itemQuantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="1" min="1" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
            
            <textarea id="itemDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="width: 100%; height: 120px; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; resize: vertical; font-size: 16px;"></textarea>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-plus" onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    `;
    document.body.appendChild(popup);
}

function addItem() {
    const name = document.getElementById('itemName').value.trim();
    const category = document.getElementById('itemCategory').value;
    const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
    const description = document.getElementById('itemDescription').value.trim();
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞!');
        return;
    }
    
    if (!inventory[category]) {
        inventory[category] = [];
    }
    
    inventory[category].push({
        id: Date.now(),
        name,
        quantity,
        description,
        expanded: false
    });
    
    saveInventory();
    renderInventory();
    document.querySelector('.popup').remove();
    alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!');
}

function renderInventory() {
    const container = document.getElementById('inventoryContainer');
    const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
    
    let inventoryHTML = '';
    
    const standardCategories = ['weapons', 'armor', 'potions', 'scrolls', 'resources', 'valuables', 'tools', 'other'];
    standardCategories.forEach(category => {
        if (inventory[category] && inventory[category].length > 0) {
            let filteredItems = inventory[category];
            if (searchTerm) {
                filteredItems = inventory[category].filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                    (item.quantity && item.quantity.toString().includes(searchTerm))
                );
            }
            
            if (filteredItems.length > 0) {
                inventoryHTML += createCategoryHTML(category, filteredItems);
            }
        }
    });
    
    customCategories.forEach(categoryId => {
        if (inventory[categoryId] && inventory[categoryId].length > 0) {
            let filteredItems = inventory[categoryId];
            if (searchTerm) {
                filteredItems = inventory[categoryId].filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                    (item.quantity && item.quantity.toString().includes(searchTerm))
                );
            }
            
            if (filteredItems.length > 0) {
                inventoryHTML += createCategoryHTML(categoryId, filteredItems);
            }
        }
    });
    
    container.innerHTML = inventoryHTML || '<p style="color: #8b7d6b; text-align: center;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
}

function createCategoryHTML(category, items) {
    return `
        <div class="skills-section">
            <div class="section-title">${getCategoryName(category)}</div>
            ${items.map((item, index) => `
                <div class="inventory-item">
                    <div class="item-header">
                        <div class="item-name">
                            ${getCategoryIcon(category)}
                            ${item.name}
                            ${item.quantity > 1 ? `<span class="item-quantity">√ó${item.quantity}</span>` : ''}
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="editItem('${category}', ${index})" style="background: #3498db;">‚úèÔ∏è</button>
                            <button class="btn btn-small" onclick="deleteItem('${category}', ${index})" style="background: #c44536;">‚ùå</button>
                            ${item.description ? `
                                <button class="btn btn-small" onclick="toggleItemExpand('${category}', ${index})" style="background: #8b4513;">
                                    ${item.expanded ? '‚ñº' : '‚ñ∂'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    ${item.description && item.expanded ? `
                        <div class="item-description">
                            ${item.description}
                        </div>
                    ` : ''}
                </div>
            `).join('')}
        </div>
    `;
}

function getCategoryName(category) {
    const customName = localStorage.getItem(`category_name_${category}`);
    if (customName) return customName;
    
    const names = {
        weapons: '‚öîÔ∏è –û—Ä—É–∂–∏–µ',
        armor: 'üõ°Ô∏è –ë—Ä–æ–Ω—è',
        potions: 'üß™ –ó–µ–ª—å—è',
        scrolls: 'üìú –°–≤–∏—Ç–∫–∏',
        resources: 'üíé –†–µ—Å—É—Ä—Å—ã',
        valuables: 'üí∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏',
        tools: 'üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã',
        other: 'üéí –ü—Ä–æ—á–µ–µ'
    };
    return names[category] || category;
}

function getCategoryIcon(category) {
    const icons = {
        weapons: '‚öîÔ∏è',
        armor: 'üõ°Ô∏è',
        potions: 'üß™',
        scrolls: 'üìú',
        resources: 'üíé',
        valuables: 'üí∞',
        tools: 'üîß',
        other: 'üéí'
    };
    return icons[category] || 'üìÅ';
}

function editItem(category, index) {
    const item = inventory[category][index];
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
        <div class="popup-content">
            <h2 style="color: #d4af37;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h2>
            <input type="text" id="editItemName" value="${item.name}" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
            
            <select id="editItemCategory" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
                <option value="weapons" ${category === 'weapons' ? 'selected' : ''}>‚öîÔ∏è –û—Ä—É–∂–∏–µ</option>
                <option value="armor" ${category === 'armor' ? 'selected' : ''}>üõ°Ô∏è –ë—Ä–æ–Ω—è</option>
                <option value="potions" ${category === 'potions' ? 'selected' : ''}>üß™ –ó–µ–ª—å—è</option>
                <option value="scrolls" ${category === 'scrolls' ? 'selected' : ''}>üìú –°–≤–∏—Ç–∫–∏</option>
                <option value="resources" ${category === 'resources' ? 'selected' : ''}>üíé –†–µ—Å—É—Ä—Å—ã</option>
                <option value="valuables" ${category === 'valuables' ? 'selected' : ''}>üí∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏</option>
                <option value="tools" ${category === 'tools' ? 'selected' : ''}>üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
                <option value="other" ${category === 'other' ? 'selected' : ''}>üéí –ü—Ä–æ—á–µ–µ</option>
                ${customCategories.map(catId => `
                    <option value="${catId}" ${category === catId ? 'selected' : ''}>${getCategoryName(catId)}</option>
                `).join('')}
            </select>
            
            <input type="number" id="editItemQuantity" value="${item.quantity}" min="1" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
            
            <textarea id="editItemDescription" style="width: 100%; height: 120px; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; resize: vertical; font-size: 16px;">${item.description}</textarea>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-plus" onclick="saveEditedItem('${category}', ${index})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    `;
    document.body.appendChild(popup);
}

function saveEditedItem(oldCategory, index) {
    const name = document.getElementById('editItemName').value.trim();
    const newCategory = document.getElementById('editItemCategory').value;
    const quantity = parseInt(document.getElementById('editItemQuantity').value) || 1;
    const description = document.getElementById('editItemDescription').value.trim();
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞!');
        return;
    }
    
    const item = inventory[oldCategory].splice(index, 1)[0];
    
    item.name = name;
    item.quantity = quantity;
    item.description = description;
    
    if (!inventory[newCategory]) {
        inventory[newCategory] = [];
    }
    inventory[newCategory].push(item);
    
    saveInventory();
    renderInventory();
    document.querySelector('.popup').remove();
}

function deleteItem(category, index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?')) {
        inventory[category].splice(index, 1);
        saveInventory();
        renderInventory();
    }
}

function toggleItemExpand(category, index) {
    inventory[category][index].expanded = !inventory[category][index].expanded;
    saveInventory();
    renderInventory();
}

// ========== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò ==========
function showAddCategoryPopup() {
    document.getElementById('customCategoriesSection').style.display = 'block';
}

function addCustomCategory() {
    const categoryName = document.getElementById('newCategoryName').value.trim();
    if (!categoryName) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞!');
        return;
    }

    const categoryId = categoryName.toLowerCase().replace(/[^a-z0-9–∞-—è]/g, '_');
    
    if (inventory.hasOwnProperty(categoryId) || customCategories.includes(categoryId)) {
        alert('–†–∞–∑–¥–µ–ª —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
        return;
    }

    customCategories.push(categoryId);
    inventory[categoryId] = [];
    saveCustomCategories();
    saveInventory();
    
    document.getElementById('newCategoryName').value = '';
    updateCategoryManagement();
    renderInventory();
    
    alert(`‚úÖ –†–∞–∑–¥–µ–ª "${categoryName}" —Å–æ–∑–¥–∞–Ω!`);
}

function updateCategoryManagement() {
    const container = document.getElementById('customCategoriesList');
    if (customCategories.length === 0) {
        container.innerHTML = '<p style="color: #8b7d6b; text-align: center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –Ω–µ—Ç</p>';
        return;
    }

    let html = '';
    customCategories.forEach(categoryId => {
        const categoryName = getCategoryName(categoryId);
        const itemCount = inventory[categoryId] ? inventory[categoryId].length : 0;
        
        html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #2c1810; margin: 5px 0; border-radius: 4px;">
                <span>${categoryName} (${itemCount} –ø—Ä–µ–¥–º–µ—Ç–æ–≤)</span>
                <div>
                    <button class="btn btn-small" onclick="editCustomCategory('${categoryId}')" style="background: #3498db;">‚úèÔ∏è</button>
                    <button class="btn btn-small" onclick="deleteCustomCategory('${categoryId}')" style="background: #c44536;">‚ùå</button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function editCustomCategory(categoryId) {
    const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞:', getCategoryName(categoryId));
    if (newName && newName.trim()) {
        localStorage.setItem(`category_name_${categoryId}`, newName.trim());
        updateCategoryManagement();
        renderInventory();
    }
}

function deleteCustomCategory(categoryId) {
    if (inventory[categoryId] && inventory[categoryId].length > 0) {
        if (!confirm(`–í —Ä–∞–∑–¥–µ–ª–µ –µ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã! –£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª "${getCategoryName(categoryId)}" –∏ –≤—Å–µ –µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç—ã?`)) {
            return;
        }
    } else {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª "${getCategoryName(categoryId)}"?`)) {
            return;
        }
    }

    customCategories = customCategories.filter(id => id !== categoryId);
    delete inventory[categoryId];
    localStorage.removeItem(`category_name_${categoryId}`);
    
    saveCustomCategories();
    saveInventory();
    updateCategoryManagement();
    renderInventory();
}
</script>
<script>
// ========== –°–ò–°–¢–ï–ú–ê –ó–ê–ú–ï–¢–û–ö ==========

function showAddNotePopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
        <div class="popup-content">
            <h2 style="color: #d4af37;">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</h2>
            <input type="text" id="noteTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
            <textarea id="noteContent" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏" style="width: 100%; height: 200px; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; resize: vertical; font-size: 16px;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-plus" onclick="addNote()">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    `;
    document.body.appendChild(popup);
}

function addNote() {
    const title = document.getElementById('noteTitle').value.trim();
    const content = document.getElementById('noteContent').value.trim();
    
    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏!');
        return;
    }
    
    notes.push({
        id: Date.now(),
        title,
        content,
        expanded: false
    });
    
    saveNotes();
    renderNotes();
    document.querySelector('.popup').remove();
}

function renderNotes() {
    const container = document.getElementById('notesContainer');
    const searchTerm = document.getElementById('notesSearch').value.toLowerCase();
    
    let filteredNotes = notes;
    if (searchTerm) {
        filteredNotes = notes.filter(note => 
            note.title.toLowerCase().includes(searchTerm) || 
            note.content.toLowerCase().includes(searchTerm)
        );
    }
    
    if (filteredNotes.length === 0) {
        container.innerHTML = '<p style="color: #8b7d6b; text-align: center;">–ó–∞–º–µ—Ç–æ–∫ –Ω–µ—Ç</p>';
        return;
    }
    
    let notesHTML = '';
    filteredNotes.forEach((note, index) => {
        const preview = note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content;
        notesHTML += `
            <div class="note-item">
                <div class="note-header">
                    <span class="note-title">${note.title}</span>
                    <div class="note-actions">
                        <button class="btn btn-small" onclick="editNote(${index})" style="background: #3498db;">‚úèÔ∏è</button>
                        <button class="btn btn-small" onclick="deleteNote(${index})" style="background: #c44536;">‚ùå</button>
                        <button class="btn btn-small" onclick="toggleNoteExpand(${index})" style="background: #8b4513;">
                            ${note.expanded ? '‚ñº' : '‚ñ∂'}
                        </button>
                    </div>
                </div>
                <div class="note-preview">
                    ${note.expanded ? note.content : preview}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = notesHTML;
}

function editNote(index) {
    const note = notes[index];
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
        <div class="popup-content">
            <h2 style="color: #d4af37;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</h2>
            <input type="text" id="editNoteTitle" value="${note.title}" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
            <textarea id="editNoteContent" style="width: 100%; height: 200px; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; resize: vertical; font-size: 16px;">${note.content}</textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-plus" onclick="saveEditedNote(${index})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    `;
    document.body.appendChild(popup);
}

function saveEditedNote(index) {
    const title = document.getElementById('editNoteTitle').value.trim();
    const content = document.getElementById('editNoteContent').value.trim();
    
    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏!');
        return;
    }
    
    notes[index].title = title;
    notes[index].content = content;
    
    saveNotes();
    renderNotes();
    document.querySelector('.popup').remove();
}

function deleteNote(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) {
        notes.splice(index, 1);
        saveNotes();
        renderNotes();
    }
}

function toggleNoteExpand(index) {
    notes[index].expanded = !notes[index].expanded;
    saveNotes();
    renderNotes();
}

// ========== –°–ò–°–¢–ï–ú–ê –ö–£–ë–ò–ö–û–í ==========

function rollDice(diceType) {
    const count = parseInt(document.getElementById('diceCount').value) || 1;
    let results = [];
    let total = 0;
    
    if (diceType === 'coin') {
        for (let i = 0; i < count; i++) {
            const result = Math.random() > 0.5 ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞';
            results.push(result);
        }
    } else {
        for (let i = 0; i < count; i++) {
            const result = Math.floor(Math.random() * diceType) + 1;
            results.push(result);
            total += result;
        }
    }
    
    displayDiceResults(diceType, count, results, total);
    addToDiceHistory(diceType, count, results, total);
}

function rollCustomDice() {
    const sides = parseInt(document.getElementById('customDiceSides').value) || 6;
    if (sides < 2) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–Ω–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω—å—à–µ 2!');
        return;
    }
    rollDice(sides);
}

function displayDiceResults(diceType, count, results, total) {
    const container = document.getElementById('diceResults');
    let resultHTML = '';
    
    if (diceType === 'coin') {
        resultHTML = `<h3 style="color: #d4af37;">–ú–æ–Ω–µ—Ç–∫–∞ (${count} —Ä–∞–∑):</h3>`;
        resultHTML += `<div style="font-size: 1.2em; margin: 10px 0;">${results.join(', ')}</div>`;
    } else {
        const diceName = diceType === 0 ? '–ö–∞—Å—Ç–æ–º–Ω—ã–π' : `D${diceType}`;
        resultHTML = `<h3 style="color: #d4af37;">–ë—Ä–æ—Å–æ–∫ ${count}d${diceType}:</h3>`;
        resultHTML += `<div style="font-size: 1.2em; margin: 10px 0;">${results.join(' + ')}`;
        if (count > 1) {
            resultHTML += ` = <strong>${total}</strong>`;
        }
        resultHTML += `</div>`;
    }
    
    container.innerHTML = resultHTML;
}

function addToDiceHistory(diceType, count, results, total) {
    const timestamp = new Date().toLocaleTimeString();
    let entry = {
        timestamp,
        diceType: diceType === 'coin' ? '–ú–æ–Ω–µ—Ç–∫–∞' : `D${diceType}`,
        count,
        results: [...results],
        total
    };
    
    diceHistory.unshift(entry);
    if (diceHistory.length > 10) diceHistory.pop();
    renderDiceHistory();
}

function renderDiceHistory() {
    const container = document.getElementById('diceHistory');
    if (diceHistory.length === 0) {
        container.innerHTML = '<p style="color: #8b7d6b; text-align: center;">–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤ –ø—É—Å—Ç–∞</p>';
        return;
    }
    
    let historyHTML = '<h4 style="color: #d4af37; margin-bottom: 10px;">–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤:</h4>';
    diceHistory.forEach(entry => {
        if (entry.diceType === '–ú–æ–Ω–µ—Ç–∫–∞') {
            historyHTML += `<p style="margin: 5px 0;">${entry.timestamp} - ${entry.diceType}: ${entry.results.join(', ')}</p>`;
        } else {
            historyHTML += `<p style="margin: 5px 0;">${entry.timestamp} - ${entry.count}${entry.diceType}: [${entry.results.join(', ')}]`;
            if (entry.count > 1) {
                historyHTML += ` = ${entry.total}`;
            }
            historyHTML += `</p>`;
        }
    });
    
    container.innerHTML = historyHTML;
}

// ========== –ì–ï–ù–ï–†–ê–¢–û–†–´ ==========

function generateNameForRace(raceId, gender = null) {
    if (!nameGenerators[raceId]) return null;
    
    const generator = nameGenerators[raceId];
    
    if (!gender) {
        gender = Math.random() > 0.5 ? 'male' : 'female';
    }
    
    const firstNames = generator[gender];
    const surnames = generator.surnames;
    
    if (!firstNames || !surnames) return null;
    
    const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
    const surname = surnames[Math.floor(Math.random() * surnames.length)];
    
    return {
        firstName,
        surname,
        gender: gender === 'male' ? '–ú—É–∂—Å–∫–æ–µ' : '–ñ–µ–Ω—Å–∫–æ–µ'
    };
}

function generateRandomAge(raceId) {
    const race = races[raceId];
    const lifespan = parseInt(race.lifespan) || 300;
    return Math.max(15, Math.floor(Math.random() * lifespan * 0.3) + 15);
}

function generateRandomTrait() {
    const types = Object.keys(traits);
    const randomType = types[Math.floor(Math.random() * types.length)];
    const randomTrait = traits[randomType].general[Math.floor(Math.random() * traits[randomType].general.length)];
    return randomTrait;
}

function generateRandomNickname() {
    const types = Object.keys(nicknames);
    const randomType = types[Math.floor(Math.random() * types.length)];
    const randomNickname = nicknames[randomType][Math.floor(Math.random() * nicknames[randomType].length)];
    return randomNickname;
}

function generateFullCharacter() {
    const race = document.getElementById('genRace').value;
    const gender = document.getElementById('genGender').value;
    
    if (!race) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É!');
        return;
    }
    
    const finalGender = gender === 'random' ? (Math.random() > 0.5 ? 'male' : 'female') : gender;
    const nameData = generateNameForRace(race, finalGender);
    const height = generateRandomHeight(race);
    const age = generateRandomAge(race);
    const trait = generateRandomTrait();
    const nickname = generateRandomNickname();
    
    const resultDiv = document.getElementById('characterResult');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <h3 style="color: #d4af37; margin-bottom: 15px;">üé≠ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><strong>–ò–º—è:</strong> ${nameData.firstName}</div>
            <div><strong>–§–∞–º–∏–ª–∏—è:</strong> ${nameData.surname}</div>
            <div><strong>–†–∞—Å–∞:</strong> ${races[race].name}</div>
            <div><strong>–ü–æ–ª:</strong> ${nameData.gender}</div>
            <div><strong>–†–æ—Å—Ç:</strong> ${height} —Å–º</div>
            <div><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${age} –ª–µ—Ç</div>
        </div>
        <div style="margin-top: 15px;">
            <strong>–û—Ç–ª–∏—á–∏—Ç–µ–ª—å–Ω–∞—è —á–µ—Ä—Ç–∞:</strong> ${trait}<br>
            <strong>–ü—Ä–æ–∑–≤–∏—â–µ:</strong> "${nickname}"
        </div>
        <button class="btn btn-plus" onclick="applyGeneratedCharacter('${nameData.firstName}', '${nameData.surname}', ${height}, ${age})" style="margin-top: 15px; width: 100%;">
            ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –ø–µ—Ä—Å–æ–Ω–∞–∂—É
        </button>
    `;
}

function generateName() {
    const nameType = document.getElementById('nameType').value;
    const theme = document.getElementById('nameTheme').value.toLowerCase();
    
    let name = '';
    
    if (nameTemplates[nameType]) {
        const template = nameTemplates[nameType];
        const prefix = template.prefixes[Math.floor(Math.random() * template.prefixes.length)];
        const base = template.bases[Math.floor(Math.random() * template.bases.length)];
        const suffix = template.suffixes[Math.floor(Math.random() * template.suffixes.length)];
        
        name = `${prefix} ${base}${suffix}`;
        
        if (theme) {
            const themedSuffixes = {
                sea: [" —É –ü—Ä–∏—á–∞–ª–∞", " –ú–æ—Ä—è–∫–∞", " –í–æ–ª–Ω—ã", " –ü—Ä–∏–ª–∏–≤–∞", " –û–∫–µ–∞–Ω–∞"],
                forest: [" —É –õ–µ—Å–∞", " –û—Ö–æ—Ç–Ω–∏–∫–∞", " –¢—Ä–æ–ø—ã", " –†–æ—â–∏", " –î–µ—Ä–µ–≤–∞"],
                mountain: [" –≤ –ì–æ—Ä–∞—Ö", " –°–∫–∞–ª—ã", " –£—Ç–µ—Å–∞", " –í–µ—Ä—à–∏–Ω—ã", " –£—â–µ–ª—å—è"],
                fire: [" –û–≥–Ω—è", " –ü–ª–∞–º–µ–Ω–∏", " –í—É–ª–∫–∞–Ω–∞", " –ñ–∞—Ä–∞", " –ü–µ–ø–ª–∞"],
                river: [" —É –†–µ–∫–∏", " –†—É—á—å—è", " –ë—Ä–æ–¥–∞", " –í–æ–¥–æ–ø–∞–¥–∞", " –ò—Å—Ç–æ–∫–∞"]
            };
            
            if (themedSuffixes[theme]) {
                const themedSuffix = themedSuffixes[theme][Math.floor(Math.random() * themedSuffixes[theme].length)];
                name += themedSuffix;
            }
        }
    }
    
    const resultDiv = document.getElementById('nameResult');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <h4 style="color: #d4af37; margin-bottom: 10px;">${getIconForNameType(nameType)} ${name}</h4>
        <button class="btn btn-small" onclick="copyToClipboard('${name}')" style="background: #27ae60;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    `;
}

function generateTrait() {
    const traitType = document.getElementById('traitType').value;
    const theme = document.getElementById('traitTheme').value.toLowerCase();
    
    let trait = '';
    
    if (theme && traits[traitType].themes[theme]) {
        const themedTraits = traits[traitType].themes[theme];
        trait = themedTraits[Math.floor(Math.random() * themedTraits.length)];
    } else {
        const generalTraits = traits[traitType].general;
        trait = generalTraits[Math.floor(Math.random() * generalTraits.length)];
    }
    
    const resultDiv = document.getElementById('traitResult');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <h4 style="color: #d4af37; margin-bottom: 10px;">üé≠ ${trait}</h4>
        <button class="btn btn-small" onclick="copyToClipboard('${trait}')" style="background: #27ae60;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    `;
}

function generateNickname() {
    const nicknameType = document.getElementById('nicknameType').value;
    const nicknameList = nicknames[nicknameType];
    const nickname = nicknameList[Math.floor(Math.random() * nicknameList.length)];
    
    const resultDiv = document.getElementById('nicknameResult');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <h4 style="color: #d4af37; margin-bottom: 10px;">üéØ "${nickname}"</h4>
        <button class="btn btn-small" onclick="copyToClipboard('${nickname}')" style="background: #27ae60;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    `;
}

function getIconForNameType(type) {
    const icons = {
        tavern: "üç∫", inn: "üèöÔ∏è", shop: "üõçÔ∏è", blacksmith: "‚öíÔ∏è",
        temple: "‚õ™", city: "üè∞", kingdom: "üëë", ship: "‚õµ", gang: "üíÄ"
    };
    return icons[type] || "üèõÔ∏è";
}

function applyGeneratedCharacter(firstName, surname, height, age) {
    document.getElementById('characterName').value = firstName;
    document.getElementById('characterSurname').value = surname;
    document.getElementById('characterHeight').value = height;
    document.getElementById('characterAge').value = age;
    saveCharacterData();
    
    alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${firstName} ${surname}" –ø—Ä–∏–º–µ–Ω–µ–Ω!`);
    openTab('character');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
}
</script>
<script>
// ========== –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê–ú–ò ==========

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
function loadCharacters() {
    const saved = localStorage.getItem('dnd_characters');
    if (saved) {
        characters = JSON.parse(saved);
    }
    const savedCurrent = localStorage.getItem('current_character_id');
    if (savedCurrent) {
        currentCharacterId = savedCurrent;
    }
    renderCharactersList();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
function saveCharacters() {
    localStorage.setItem('dnd_characters', JSON.stringify(characters));
    localStorage.setItem('current_character_id', currentCharacterId);
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function showCreateCharacterPopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
        <div class="popup-content">
            <h2 style="color: #d4af37;">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
            <input type="text" id="newCharacterName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
            <select id="newCharacterRace" style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É</option>
                <option value="atski">–ê—Ü–∫–∏</option>
                <option value="knofi">–ö–Ω–æ—Ñ—ã</option>
                <option value="vorki">–í–æ—Ä–∫–∏</option>
                <option value="minci">–ú–∏–Ω—Ü—ã</option>
                <option value="kaei">–ö–∞—ç–π—Ü—ã</option>
                <option value="forest_elf">–õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                <option value="high_elf">–í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã</option>
                <option value="dark_elf">–¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                <option value="dwarf">–î–≤–∞—Ä—Ñ—ã</option>
                <option value="gnome">–ì–Ω–æ–º—ã</option>
                <option value="orc">–û—Ä–∫–∏</option>
                <option value="goblin">–ì–æ–±–ª–∏–Ω—ã</option>
            </select>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-plus" onclick="createNewCharacter()">–°–æ–∑–¥–∞—Ç—å</button>
                <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    `;
    document.body.appendChild(popup);
}

function createNewCharacter() {
    const name = document.getElementById('newCharacterName').value.trim();
    const race = document.getElementById('newCharacterRace').value;
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
    }
    if (!race) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
    }

    const characterId = 'char_' + Date.now();
    const randomHeight = generateRandomHeight(race);

    // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    const newCharacter = {
        id: characterId,
        name: name,
        info: {
            name: name,
            surname: "",
            title: "",
            race: race,
            heritage: "",
            height: randomHeight,
            weight: "",
            age: Math.max(15, Math.floor(parseInt(races[race].lifespan) * 0.1))
        },
        level: {
            current: 0,
            exp: 0
        },
        stats: {
            health: 100,
            mana: 100,
            stamina: 100,
            freePoints: 0
        },
        skills: {},
        lockedSkills: {},
        magic: {
            availableSchools: {},
            spells: JSON.parse(JSON.stringify(spellsBySchool))
        },
        inventory: {
            weapons: [], armor: [], potions: [], scrolls: [], 
            resources: [], valuables: [], tools: [], other: []
        },
        customCategories: [],
        notes: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫–∏
    Object.values(skillsStructure).forEach(skillGroup => {
        skillGroup.forEach(skill => {
            newCharacter.skills[skill] = 5;
        });
    });

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —à–∫–æ–ª—ã –º–∞–≥–∏–∏
    determineAvailableMagicSchoolsForCharacter(newCharacter, race);
    
    characters[characterId] = newCharacter;
    saveCharacters();
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    switchCharacter(characterId);
    document.querySelector('.popup').remove();
    alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${name}" —Å–æ–∑–¥–∞–Ω!`);
}

function determineAvailableMagicSchoolsForCharacter(character, raceId) {
    character.magic.availableSchools = {};
    
    switch(raceId) {
        case 'forest_elf':
            character.magic.availableSchools["–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã"] = true;
            break;
        case 'dark_elf':
            character.magic.availableSchools["–ú–∞–≥–∏—è —Ç—å–º—ã"] = true;
            break;
        case 'high_elf':
            const shuffled = [...baseMagicSchools].sort(() => 0.5 - Math.random());
            character.magic.availableSchools[shuffled[0]] = true;
            character.magic.availableSchools[shuffled[1]] = true;
            break;
        case 'goblin':
            break;
        default:
            const randomSchool = baseMagicSchools[Math.floor(Math.random() * baseMagicSchools.length)];
            character.magic.availableSchools[randomSchool] = true;
    }

    const race = races[raceId];
    if (race && race.limitations) {
        Object.keys(race.limitations).forEach(school => {
            if (race.limitations[school] === 0) {
                character.magic.availableSchools[school] = false;
            }
        });
    }
}

// –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
function renderCharactersList() {
    const container = document.getElementById('charactersList');
    if (Object.keys(characters).length === 0) {
        container.innerHTML = '<p style="color: #8b7d6b; text-align: center;">–ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        return;
    }

    let html = '';
    Object.values(characters).forEach(character => {
        const isCurrent = currentCharacterId === character.id;
        const raceInfo = races[character.info.race] || { name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
        
        html += `
            <div class="character-item ${isCurrent ? 'active' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #d4af37; font-size: 1.1em;">${character.info.name}</div>
                        <div style="color: #b8a28a; font-size: 0.9em; margin-top: 5px;">
                            ${raceInfo.name} | –£—Ä. ${character.level.current} | –û–ø—ã—Ç: ${character.level.exp}
                        </div>
                        <div style="color: #8b7d6b; font-size: 0.8em; margin-top: 5px;">
                            –°–æ–∑–¥–∞–Ω: ${new Date(character.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px; margin-left: 10px;">
                        ${!isCurrent ? 
                            `<button class="btn btn-small" onclick="switchCharacter('${character.id}')" style="background: #27ae60;">üéØ –í—ã–±—Ä–∞—Ç—å</button>` : 
                            `<button class="btn btn-small" disabled style="background: #5a3928;">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</button>`
                        }
                        <button class="btn btn-small" onclick="exportSingleCharacter('${character.id}')" style="background: #3498db;">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button class="btn btn-small" onclick="showRenameCharacterPopup('${character.id}')" style="background: #f39c12;">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-small" onclick="showDeleteCharacterPopup('${character.id}')" style="background: #c44536;">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
function switchCharacter(characterId) {
    if (!characters[characterId]) {
        alert('–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if (currentCharacterId && characters[currentCharacterId]) {
        saveCurrentCharacter();
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    currentCharacterId = characterId;
    loadCurrentCharacter();
    saveCharacters();

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    renderCharactersList();
    updateUI();
    updateLevelDisplay();

    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    openTab('character');
    alert(`‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ${characters[characterId].info.name}`);
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function saveCurrentCharacter() {
    if (!currentCharacterId) return;
    
    const character = characters[currentCharacterId];
    if (!character) return;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    character.info = {
        name: document.getElementById('characterName').value,
        surname: document.getElementById('characterSurname').value,
        title: document.getElementById('characterTitle').value,
        race: document.getElementById('characterRace').value,
        heritage: document.getElementById('characterHeritage').value,
        height: document.getElementById('characterHeight').value,
        weight: document.getElementById('characterWeight').value,
        age: document.getElementById('characterAge').value
    };

    character.level = {
        current: getCurrentLevel(),
        exp: getCurrentExp()
    };

    character.stats = {
        health: getHealth(),
        mana: getMana(),
        stamina: getStamina(),
        freePoints: getFreePoints()
    };

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–≤—ã–∫–∏
    character.skills = {};
    Object.values(skillsStructure).forEach(skillGroup => {
        skillGroup.forEach(skill => {
            character.skills[skill] = getSkillValue(skill);
        });
    });

    character.lockedSkills = lockedSkills;
    character.magic.availableSchools = availableMagicSchools;
    character.inventory = inventory;
    character.customCategories = customCategories;
    character.notes = notes;
    character.updatedAt = new Date().toISOString();

    saveCharacters();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function loadCurrentCharacter() {
    if (!currentCharacterId || !characters[currentCharacterId]) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ
        if (Object.keys(characters).length === 0) {
            showCreateCharacterPopup();
            return;
        }
        // –ò–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ
        currentCharacterId = Object.keys(characters)[0];
    }

    const character = characters[currentCharacterId];

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    document.getElementById('characterName').value = character.info.name || '';
    document.getElementById('characterSurname').value = character.info.surname || '';
    document.getElementById('characterTitle').value = character.info.title || '';
    document.getElementById('characterRace').value = character.info.race || '';
    document.getElementById('characterHeritage').value = character.info.heritage || '';
    document.getElementById('characterHeight').value = character.info.height || '';
    document.getElementById('characterWeight').value = character.info.weight || '';
    document.getElementById('characterAge').value = character.info.age || '';

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Ä–æ–≤–Ω–∏
    setCurrentLevel(character.level.current || 0);
    setCurrentExp(character.level.exp || 0);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    setHealth(character.stats.health || 100);
    setMana(character.stats.mana || 100);
    setStamina(character.stats.stamina || 100);
    setFreePoints(character.stats.freePoints || 0);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–≤—ã–∫–∏
    Object.entries(character.skills || {}).forEach(([skill, value]) => {
        setSkillValue(skill, value);
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    lockedSkills = character.lockedSkills || {};
    availableMagicSchools = character.magic.availableSchools || {};
    inventory = character.inventory || { weapons: [], armor: [], potions: [], scrolls: [], resources: [], valuables: [], tools: [], other: [] };
    customCategories = character.customCategories || [];
    notes = character.notes || [];

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    renderSkills();
    renderInventory();
    renderNotes();
    updateCategoryManagement();
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
function showRenameCharacterPopup(characterId) {
    const character = characters[characterId];
    const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', character.info.name);
    if (newName && newName.trim()) {
        character.info.name = newName.trim();
        character.updatedAt = new Date().toISOString();
        saveCharacters();
        renderCharactersList();
        alert('‚úÖ –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑–º–µ–Ω–µ–Ω–æ!');
    }
}

function showDeleteCharacterPopup(characterId) {
    const character = characters[characterId];
    
    if (Object.keys(characters).length <= 1) {
        alert('‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
    }

    if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ "${character.info.name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        delete characters[characterId];
        
        // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥–æ–≥–æ
        if (currentCharacterId === characterId) {
            const remainingIds = Object.keys(characters);
            if (remainingIds.length > 0) {
                switchCharacter(remainingIds[0]);
            } else {
                currentCharacterId = null;
            }
        }
        
        saveCharacters();
        renderCharactersList();
        alert('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —É–¥–∞–ª–µ–Ω!');
    }
}

function showClearAllPopup() {
    if (Object.keys(characters).length === 0) {
        alert('–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!');
        return;
    }

    if (confirm(`‚ùå –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï–• –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (${Object.keys(characters).length} —à—Ç.)!\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        characters = {};
        currentCharacterId = null;
        saveCharacters();
        location.reload();
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
function exportSingleCharacter(characterId) {
    const character = characters[characterId];
    const dataStr = JSON.stringify(character, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `character_${character.info.name || 'unknown'}.json`;
    link.click();
    
    alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${character.info.name}" —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
}

function exportAllCharacters() {
    if (Object.keys(characters).length === 0) {
        alert('–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!');
        return;
    }

    const dataStr = JSON.stringify(characters, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `dnd_characters_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    alert(`‚úÖ –í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ (${Object.keys(characters).length} —à—Ç.) —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!`);
}

function showImportCharacterPopup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const characterData = JSON.parse(e.target.result);
                importCharacterData(characterData);
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞!');
                console.error(error);
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

function importCharacterData(characterData) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞
    if (!characterData.info || !characterData.info.name) {
        // –ï—Å–ª–∏ —ç—Ç–æ —Ñ–∞–π–ª —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
        if (characterData.info === undefined && Object.keys(characterData).length > 0) {
            let importedCount = 0;
            Object.values(characterData).forEach(char => {
                if (char.info && char.info.name) {
                    const newId = 'char_import_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    characters[newId] = char;
                    characters[newId].id = newId;
                    characters[newId].updatedAt = new Date().toISOString();
                    importedCount++;
                }
            });
            saveCharacters();
            renderCharactersList();
            alert(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importedCount} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!`);
            return;
        }
        alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
    }

    // –ï—Å–ª–∏ —ç—Ç–æ –æ–¥–∏–Ω–æ—á–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂
    const newId = 'char_import_' + Date.now();
    characters[newId] = characterData;
    characters[newId].id = newId;
    characters[newId].updatedAt = new Date().toISOString();
    
    saveCharacters();
    renderCharactersList();
    alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${characterData.info.name}" –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
function setupAutoSave() {
    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º saveCharacterData –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const originalSaveCharacterData = saveCharacterData;
    saveCharacterData = function() {
        originalSaveCharacterData();
        if (currentCharacterId) {
            saveCurrentCharacter();
        }
    };

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    const originalSaveInventory = saveInventory;
    saveInventory = function() {
        originalSaveInventory();
        if (currentCharacterId) {
            saveCurrentCharacter();
        }
    };

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–æ–∫
    const originalSaveNotes = saveNotes;
    saveNotes = function() {
        originalSaveNotes();
        if (currentCharacterId) {
            saveCurrentCharacter();
        }
    };
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

// –ì–µ—Ç—Ç–µ—Ä—ã/—Å–µ—Ç—Ç–µ—Ä—ã –¥–ª—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
function getFreePoints() { 
    const element = document.getElementById('freePoints');
    return element ? parseInt(element.value) || 0 : 0; 
}

function setFreePoints(value) { 
    const element = document.getElementById('freePoints');
    if (element) element.value = value; 
}

function getCurrentLevel() { 
    return parseInt(localStorage.getItem('currentLevel')) || 0; 
}

function setCurrentLevel(value) { 
    localStorage.setItem('currentLevel', value); 
}

function getCurrentExp() { 
    return parseInt(localStorage.getItem('currentExp')) || 0; 
}

function setCurrentExp(value) { 
    localStorage.setItem('currentExp', value); 
}

function getHealth() { 
    const element = document.getElementById('health');
    return element ? parseInt(element.value) || 100 : 100; 
}

function setHealth(value) { 
    const element = document.getElementById('health');
    if (element) element.value = value; 
}

function getMana() { 
    const element = document.getElementById('mana');
    return element ? parseInt(element.value) || 100 : 100; 
}

function setMana(value) { 
    const element = document.getElementById('mana');
    if (element) element.value = value; 
}

function getStamina() { 
    const element = document.getElementById('stamina');
    return element ? parseInt(element.value) || 100 : 100; 
}

function setStamina(value) { 
    const element = document.getElementById('stamina');
    if (element) element.value = value; 
}

function getSkillValue(skillName) { 
    return parseInt(localStorage.getItem(`skill_${skillName}`)) || 5; 
}

function setSkillValue(skillName, value) { 
    localStorage.setItem(`skill_${skillName}`, value); 
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function saveCharacterData() {
    localStorage.setItem('characterName', document.getElementById('characterName').value);
    localStorage.setItem('characterSurname', document.getElementById('characterSurname').value);
    localStorage.setItem('characterTitle', document.getElementById('characterTitle').value);
    localStorage.setItem('characterRace', document.getElementById('characterRace').value);
    localStorage.setItem('characterHeritage', document.getElementById('characterHeritage').value);
    localStorage.setItem('characterHeight', document.getElementById('characterHeight').value);
    localStorage.setItem('characterWeight', document.getElementById('characterWeight').value);
    localStorage.setItem('characterAge', document.getElementById('characterAge').value);
    localStorage.setItem('availableMagicSchools', JSON.stringify(availableMagicSchools));
}

function loadCharacterData() {
    document.getElementById('characterName').value = localStorage.getItem('characterName') || '';
    document.getElementById('characterSurname').value = localStorage.getItem('characterSurname') || '';
    document.getElementById('characterTitle').value = localStorage.getItem('characterTitle') || '';
    document.getElementById('characterRace').value = localStorage.getItem('characterRace') || '';
    document.getElementById('characterHeritage').value = localStorage.getItem('characterHeritage') || '';
    document.getElementById('characterHeight').value = localStorage.getItem('characterHeight') || '';
    document.getElementById('characterWeight').value = localStorage.getItem('characterWeight') || '';
    document.getElementById('characterAge').value = localStorage.getItem('characterAge') || '';
    
    const savedMagicSchools = localStorage.getItem('availableMagicSchools');
    if (savedMagicSchools) {
        availableMagicSchools = JSON.parse(savedMagicSchools);
    }
    
    if (localStorage.getItem('characterRace')) {
        document.getElementById('generateHeightBtn').disabled = true;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –Ω–∞–≤—ã–∫–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
function initializeSkills() {
    Object.values(skillsStructure).forEach(skillGroup => {
        skillGroup.forEach(skill => {
            if (localStorage.getItem(`skill_${skill}`) === null) {
                setSkillValue(skill, 5);
            }
        });
    });
}

// ========== –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
function loadCharacterData() {
    if (!currentCharacterId || !characters[currentCharacterId]) return;
    
    const character = characters[currentCharacterId];
    
    document.getElementById('characterName').value = character.info.name || '';
    document.getElementById('characterSurname').value = character.info.surname || '';
    document.getElementById('characterTitle').value = character.info.title || '';
    document.getElementById('characterRace').value = character.info.race || '';
    document.getElementById('characterHeritage').value = character.info.heritage || '';
    document.getElementById('characterHeight').value = character.info.height || '';
    document.getElementById('characterWeight').value = character.info.weight || '';
    document.getElementById('characterAge').value = character.info.age || '';

    setCurrentLevel(character.level.current || 0);
    setCurrentExp(character.level.exp || 0);

    setHealth(character.stats.health || 100);
    setMana(character.stats.mana || 100);
    setStamina(character.stats.stamina || 100);
    setFreePoints(character.stats.freePoints || 0);

    Object.entries(character.skills || {}).forEach(([skill, value]) => {
        setSkillValue(skill, value);
    });

    renderSkills();
    updateUI();
    updateLevelDisplay();
}

function initializeSkills() {
    Object.values(skillsStructure).forEach(skillGroup => {
        skillGroup.forEach(skill => {
            if (localStorage.getItem(`skill_${skill}`) === null) {
                setSkillValue(skill, 5);
            }
        });
    });
}
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    loadCharacters();
    setupAutoSave();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    loadCurrentCharacter();
    
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    loadCharacters();
    setupAutoSave();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    loadCurrentCharacter();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    loadNotes();
    loadInventory();
    loadSpells();
    loadLockedSkills();
    loadCustomCategories();
    loadSkillRollHistory();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫–∏
    initializeSkills();
    
    // –†–µ–Ω–¥–µ—Ä –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    renderSkills();
    renderInventory();
    renderNotes();
    updateUI();
    updateLevelDisplay();
    updateMagicSkillsDisplay();
    renderCharactersList();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π
    document.getElementById('characterName').addEventListener('input', saveCharacterData);
    document.getElementById('characterSurname').addEventListener('input', saveCharacterData);
    document.getElementById('characterTitle').addEventListener('input', saveCharacterData);
    document.getElementById('characterRace').addEventListener('change', saveCharacterData);
    document.getElementById('characterHeritage').addEventListener('input', saveCharacterData);
    document.getElementById('characterHeight').addEventListener('input', saveCharacterData);
    document.getElementById('characterWeight').addEventListener('input', saveCharacterData);
    document.getElementById('characterAge').addEventListener('input', saveCharacterData);
    document.getElementById('health').addEventListener('input', saveCharacterData);
    document.getElementById('mana').addEventListener('input', saveCharacterData);
    document.getElementById('stamina').addEventListener('input', saveCharacterData);
    
    document.getElementById('freePoints').addEventListener('input', function() {
        updateUI();
        saveCharacterData();
    });
    
    document.getElementById('currentExp').addEventListener('input', function() {
        setCurrentExp(parseInt(this.value) || 0);
        checkLevelUp();
        updateLevelDisplay();
        saveCharacterData();
    });
    
    // –°–ª—É—à–∞—Ç–µ–ª–∏ –ø–æ–∏—Å–∫–∞
    const inventorySearch = document.getElementById('inventorySearch');
    const notesSearch = document.getElementById('notesSearch');
    
    if (inventorySearch) {
        inventorySearch.addEventListener('input', renderInventory);
    }
    
    if (notesSearch) {
        notesSearch.addEventListener('input', renderNotes);
    }
    
    console.log('‚úÖ D&D Character Sheet –∑–∞–≥—Ä—É–∂–µ–Ω!');
    console.log(`üë• –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${Object.keys(characters).length}`);
    if (currentCharacterId) {
        console.log(`üéØ –¢–µ–∫—É—â–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂: ${characters[currentCharacterId].info.name}`);
    }
});
// ========== –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    loadCharacters();
    setupAutoSave();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    loadCurrentCharacter();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    loadNotes();
    loadInventory();
    loadSpells();
    loadLockedSkills();
    loadCustomCategories();
    loadSkillRollHistory();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫–∏
    initializeSkills();
    
    // –†–µ–Ω–¥–µ—Ä –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
setTimeout(() => {
    renderSkills();
    renderInventory();
    renderNotes();
    updateUI();
    updateLevelDisplay();
    updateMagicSkillsDisplay();
    renderCharactersList();
}, 100);
    
    console.log('‚úÖ D&D Character Sheet –∑–∞–≥—Ä—É–∂–µ–Ω!');
});
// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–û–°–¢–£–ü–ù–´–ï –í –ö–û–ù–°–û–õ–ò ==========

// –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - —Å–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
function resetAllData() {
    if (confirm('‚ùå –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        localStorage.clear();
        location.reload();
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function exportCharacter() {
    if (!currentCharacterId || !characters[currentCharacterId]) {
        alert('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!');
        return;
    }
    exportSingleCharacter(currentCharacterId);
}

// –ò–º–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function importCharacter() {
    showImportCharacterPopup();
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞–≤—ã–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
function getAllSkills() {
    const skills = {};
    Object.values(skillsStructure).forEach(skillGroup => {
        skillGroup.forEach(skill => {
            skills[skill] = getSkillValue(skill);
        });
    });
    return skills;
}
// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
console.log('‚úÖ D&D Character Sheet loaded successfully!');
});
// –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
function checkSystem() {
    console.log('üéØ System check passed');
    return true;
}                          
</script>
<script src="js/main.js"></script>
<script src="js/utils/storage.js"></script>
<script src="js/utils/helpers.js"></script>
<script src="js/modules/races-data.js"></script>
<script src="js/modules/character-manager.js"></script>
<script src="js/modules/skills-system.js"></script>
<script src="js/modules/magic-system.js"></script>
<script src="js/modules/inventory-system.js"></script>
<script src="js/modules/notes-system.js"></script>
<script src="js/modules/dice-system.js"></script>
<script src="js/modules/generators.js"></script>
<script src="js/modules/spells-data.js"></script>
<script src="js/modules/ui-manager.js"></script>
</body>
</html>




















































